<!DOCTYPE html>
<html lang="ko" data-page="gather-detail">
<head>
  <meta charset="UTF-8" />
  <title>모임 상세</title>
  <link rel="stylesheet" href="../css/styles.css" />
  <script src="../js/auth.js" defer></script>
  <script src="../js/scripts.js" defer></script>
  <script src="/js/sidebar.js" defer></script>
</head>
<body>
  <!-- 로그인 체크: DOM 렌더링 전에 바로 실행 -->
  <script>
    // 로그인 여부 확인 함수
    function checkLogin() {
      const userStr = localStorage.getItem("user");
      if (!userStr) {
        alert("로그인이 필요한 서비스입니다.");
        window.location.href = "/login";
        return false;
      }
      try {
        const userObj = JSON.parse(userStr);
        if (!userObj.loginId) throw new Error("로그인 정보가 유효하지 않습니다.");
        return true;
      } catch {
        alert("로그인 정보가 손상되었습니다. 다시 로그인해주세요.");
        localStorage.removeItem("user");
        window.location.href = "/login";
        return false;
      }
    }
    if (!checkLogin()) {
      // 로그인 안 되어 있으면 아래 코드 실행 안 되도록 강제 종료
      throw new Error("로그인 필요");
    }
  </script>

  <aside class="sidebar">
    <h2>도그파인더스</h2>
    <ul>
      <li><a href="/index">홈</a></li>
      <li><a href="/map">지도</a></li>
      <li><a href="/mypage">마이페이지</a></li>
      <li><a href="/mailbox">메일함</a></li>
      <li><a href="/post-list">게시글 목록</a></li>
      <li><a href="/gather">모임(모집글)</a></li>
      <li>
        <a href="/login" class="login-btn">로그인</a>
        <a href="#" class="logout-btn" style="display: none;">로그아웃</a>
      </li>
    </ul>
  </aside>

  <main>
    <h1 id="meetingTitle">모임 제목</h1>
    <p><strong>호스트:</strong> <span id="hostId"></span></p>
    <p><strong>참석자:</strong></p>
    <ul id="membersList"></ul>
    <div id="hostActions" style="margin-top: 20px;"></div>
  </main>

  <script>
    function getMeetingId() {
      const params = new URLSearchParams(window.location.search);
      return params.get("id");
    }

    async function loadMeetingDetail() {
      const meetingId = getMeetingId();
      if (!meetingId) {
        alert("잘못된 접근입니다.");
        return;
      }

      const userStr = localStorage.getItem("user");
      const loginId = userStr ? JSON.parse(userStr).loginId : null;

      try {
        const res = await fetch(`/api/meetings/${meetingId}`);
        if (!res.ok) throw new Error("모임 정보를 불러오지 못했습니다.");

        const meeting = await res.json();
        if (!meeting) throw new Error("모임이 존재하지 않습니다.");

        document.getElementById("meetingTitle").textContent = meeting.title || "제목 없음";
        document.getElementById("hostId").textContent = meeting.hostId || "알 수 없음";

        const membersList = document.getElementById("membersList");
        membersList.innerHTML = "";
        (meeting.members || []).forEach(memberId => {
          const li = document.createElement("li");
          li.textContent = memberId;
          membersList.appendChild(li);
        });

        // 호스트일 경우에만 산책 종료 버튼 표시
        if (loginId && meeting.hostId && loginId === meeting.hostId) {
          const btn = document.createElement("button");
          btn.textContent = "산책 종료";
          btn.className = "btn btn-danger";
          btn.onclick = async () => {
            if (confirm("정말 산책을 종료하시겠습니까?")) {
              const endRes = await fetch(`/api/meetings/${meetingId}/end`, {
                method: "POST"
              });
              if (endRes.ok) {
                alert("산책이 종료되었습니다.");
                location.reload();
              } else {
                alert("산책 종료에 실패했습니다.");
              }
            }
          };
          document.getElementById("hostActions").appendChild(btn);
        }

      } catch (error) {
        console.error(error);
        alert(error.message || "오류가 발생했습니다.");
      }
    }

    window.onload = () => {
      loadMeetingDetail();
    };
  </script>
</body>
</html>
