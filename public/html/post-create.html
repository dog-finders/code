<!DOCTYPE html>
<html lang="ko" data-page="post-create">
<head>
  <meta charset="UTF-8" />
  <title>모집글 작성 – 도그파인더스</title>
  <link rel="stylesheet" href="../css/styles.css" />
  <script src="../js/auth.js" defer></script>
  <script src="/js/sidebar.js" defer></script>
</head>
<body>
  <script>
    function requireLogin() {
      if (!localStorage.getItem("user")) {
        alert("로그인이 필요한 서비스입니다.");
        window.location.href = "/login";
      }
    }
    requireLogin();
  </script>

  <aside class="sidebar">
    <h2>도그파인더스</h2>
    <ul>
      <li><a id="nav-home" href="/index">홈</a></li>
      <li><a id="nav-map" href="/map">지도</a></li>
      <li><a id="nav-mypage" href="/mypage">마이페이지</a></li>
      <li><a id="nav-mailbox" href="/mailbox">메일함</a></li>
      <li><a id="nav-list" href="/post-list">게시글 목록</a></li>
      <li><a id="nav-gather" href="/gather">모임(모집글)</a></li>
      <li><a id="nav-login" href="/login">로그인</a></li>
    </ul>
  </aside>

  <main class="main">
    <div class="form-card">
      <h1>모집글 작성</h1>
      <form id="postForm">
        <div class="form-group">
          <label for="title">제목</label>
          <input type="text" id="title" placeholder="제목을 입력하세요" required>
        </div>
        <div class="form-group">
          <label for="content">내용</label>
          <textarea id="content" rows="5" placeholder="내용을 입력하세요" required></textarea>
        </div>
        <div class="form-group">
          <label for="close_at">모집 마감 시간</label>
          <input type="datetime-local" id="close_at" required>
        </div>
        <input type="hidden" id="lat" name="lat">
        <input type="hidden" id="lng" name="lng">
        <div class="btn-group">
          <button type="submit" class="btn btn-primary">작성 완료</button>
          <a href="post-list" class="btn btn-secondary">취소</a>
        </div>
      </form>
    </div>
  </main>

  <script>
    // URL에서 lat/lng를 받아 hidden input에 세팅
    window.addEventListener('DOMContentLoaded', function() {
      const params = new URLSearchParams(window.location.search);
      const lat = params.get('lat');
      const lng = params.get('lng');
      if (lat && lng) {
        document.getElementById('lat').value = lat;
        document.getElementById('lng').value = lng;
      }
    });

    document.getElementById('postForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      const title = document.getElementById('title').value.trim();
      const content = document.getElementById('content').value.trim();
      const close_at = document.getElementById('close_at').value;
      const lat = document.getElementById('lat').value;
      const lng = document.getElementById('lng').value;

      if (!title || !content || !close_at) {
        alert('모든 필수 항목을 입력해 주세요.');
        return;
      }

      // 1️⃣ 모집글 먼저 저장
      const recruitBody = { title, content, close_at, lat, lng };

      try {
        const recruitRes = await fetch('/api/recruit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(recruitBody)
        });

        if (!recruitRes.ok) {
          const err = await recruitRes.json();
          alert('모집글 작성 실패: ' + (err.message || '알 수 없는 오류'));
          return;
        }

        // recruitId 받아오기 (recruit: {id, ...} 구조 기준)
        const recruitData = await recruitRes.json();
        const recruitId = recruitData.recruit?.id;
        if (!recruitId) {
          alert('모집글 저장 결과에 recruitId가 없습니다.');
          return;
        }

        // 2️⃣ 모집글 저장 후 모임도 자동 생성 (recruitId 포함)
        const user = JSON.parse(localStorage.getItem('user'));
        const hostId = user?.id; // 반드시 숫자 ID
        if (!hostId) {
          alert('로그인 정보가 없습니다.');
          return;
        }

        const meetingBody = { title, hostId, recruitId };
        const meetingRes = await fetch('/api/meetings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(meetingBody)
        });

        if (!meetingRes.ok) {
          const err = await meetingRes.json();
          alert('모임 생성 실패: ' + (err.message || '알 수 없는 오류'));
          return;
        }

        // 3️⃣ 성공 시 목록 페이지로 이동
        window.location.href = '/post-list';

      } catch (error) {
        console.error(error);
        alert('서버 연결 오류');
      }
    });
  </script>
</body>
</html>
