<!DOCTYPE html>
<html lang="ko" data-page="mailbox">
<head>
  <meta charset="UTF-8">
  <title>메일함</title>
  <link rel="stylesheet" href="../css/styles.css">
  <script src="/js/sidebar.js" defer></script>
</head>
<body>
  <aside class="sidebar">
    <a href="/index" style="text-decoration: none; color: inherit;">
      <h2>도그파인더스</h2>
    </a>
    <ul>
      <li><a id="nav-map" href="/map">지도</a></li>
      <li><a id="nav-mypage" href="/mypage">마이페이지</a></li>
      <li><a id="nav-mailbox" href="/mailbox">메일함</a></li>
      <li><a id="nav-list" href="/post-list">모집글</a></li>
      <li><a id="nav-gather" href="/gather">모임</a></li>
      <li><a id="nav-login" href="/login">로그인</a></li>
    </ul>
  </aside>

  <main class="main">
    <h1>메일함 (참석 요청 목록)</h1>
    <table class="table">
      <thead>
        <tr><th>발신인</th><th>내용</th><th>요청일</th><th>조치</th></tr>
      </thead>
      <tbody id="request-list">
        </tbody>
    </table>
  </main>

  <script>
    window.addEventListener('DOMContentLoaded', async () => {
      try {
        const res = await fetch('/api/attend/mailbox'); // API 경로 수정
        if (!res.ok) throw new Error('요청 목록을 불러오는데 실패했습니다.');

        const requests = await res.json();
        const requestListTbody = document.getElementById('request-list');
        requestListTbody.innerHTML = ''; // 초기화

        if (requests.length === 0) {
          requestListTbody.innerHTML = '<tr><td colspan="4">받은 참석 요청이 없습니다.</td></tr>';
          return;
        }

        requests.forEach(req => {
          const tr = document.createElement('tr');
          tr.id = `request-${req.id}`;
          const formattedDate = new Date(req.createdAt).toLocaleString();
          tr.innerHTML = `
            <td>${req.applicantLoginId}</td>
            <td>'<strong>${req.recruitTitle}</strong>' 게시글에 참석 요청을 보냈습니다.</td>
            <td>${formattedDate}</td>
            <td>
              <button class="btn btn-success btn-sm" onclick="handleAccept(${req.id})">수락</button>
              <button class="btn btn-danger btn-sm" onclick="handleReject(${req.id})">거절</button>
            </td>
          `;
          requestListTbody.appendChild(tr);
        });
      } catch (error) {
        console.error(error);
        alert(error.message);
      }
    });

    async function handleAccept(attendId) {
      if (!confirm('정말 이 요청을 수락하시겠습니까?')) return;
      
      try {
        // API 경로 수정
        const res = await fetch(`/api/attend/${attendId}/accept`, { method: 'PATCH' });
        const result = await res.json();
        
        if (res.ok) {
            alert(result.message);
            document.getElementById(`request-${attendId}`).remove();
        } else {
            throw new Error(result.message);
        }
      } catch(error) {
        alert('처리 중 오류가 발생했습니다: ' + error.message);
        console.error(error);
      }
    }
    
    function handleReject(attendId) {
        alert(`attendId: ${attendId} 거절 기능은 직접 구현이 필요합니다. (API 상태 변경 등)`);
    }
  </script>
</body>
</html>