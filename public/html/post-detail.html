<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>모집글 상세 - 도그 파인더스</title>
  <link rel="stylesheet" href="../css/styles.css" />
  <script src="/js/sidebar.js" defer></script>
</head>
<body>
<aside class="sidebar">
  <h2>도그파인더스</h2>
  <ul>
    <li><a id="nav-home" href="/index">홈</a></li>
    <li><a id="nav-map" href="/map">지도</a></li>
    <li><a id="nav-mypage" href="/settings+">마이페이지</a></li>
    <li><a id="nav-list" href="/post-list">게시글 목록</a></li>
    <li><a id="nav-gather" href="/gather">모임(모집글)</a></li>
    <li><a id="nav-login" href="/login">로그인</a></li>
  </ul>
</aside>

<main class="main">
  <h3 id="postTitle">로딩 중...</h3>
  <p><strong>작성자:</strong> <span id="postWriter">알 수 없음</span></p>
  <p><strong>위치:</strong> <span id="postLocation">알 수 없음</span></p>
  <p><strong>작성일:</strong> <span id="postDate">알 수 없음</span></p>
  <hr />
  <p id="postContent">내용이 없습니다.</p>

  <a href="post-list" class="btn btn-secondary">목록으로</a>
  <button class="btn btn-primary" id="attendPostBtn">참석하기</button>
  <button class="btn btn-warning" id="closePostBtn" style="display:none;">모집 마감</button>
  <button class="btn btn-danger" id="deletePostBtn" style="display:none;">삭제</button>
</main>

<script>
  async function loadPostDetail() {
    // localStorage에 저장된 'user'를 파싱해서 loginId 추출
    const userStr = localStorage.getItem('user');
    const loginId = userStr ? JSON.parse(userStr).loginId : null;

    const urlParams = new URLSearchParams(window.location.search);
    const postId = urlParams.get('id');

    if (!postId) {
      alert("게시글 ID가 없습니다.");
      return;
    }

    try {
      const res = await fetch(`/api/recruit/${postId}`);
      if (!res.ok) throw new Error('게시글을 가져오는데 실패했습니다.');
      const post = await res.json();

      if (!post) throw new Error('게시글을 찾을 수 없습니다.');

      // 화면에 게시글 정보 표시
      document.getElementById('postTitle').textContent = post.title || '제목 없음';
      document.getElementById('postWriter').textContent = post.authorId || '알 수 없음';
      document.getElementById('postLocation').textContent = post.location || '알 수 없음';
      document.getElementById('postDate').textContent = new Date(post.created_at).toLocaleString() || '알 수 없음';
      document.getElementById('postContent').textContent = post.content || '내용이 없습니다.';

      console.log('loginId:', loginId);
      console.log('post.authorId:', post.authorId);
      console.log('같음?', loginId === post.authorId.toString());

      // 로그인 사용자와 작성자가 같은 경우
      if (loginId && post.authorId && loginId === post.authorId.toString()) {
        const deleteBtn = document.getElementById('deletePostBtn');
        const closeBtn = document.getElementById('closePostBtn');

        deleteBtn.style.display = 'inline-block';
        closeBtn.style.display = 'inline-block';

        if (post.is_closed) {
          closeBtn.disabled = true;
          closeBtn.textContent = '모집 마감됨';
        }

        closeBtn.onclick = async () => {
          if (confirm('모집을 마감하시겠습니까?')) {
            try {
              const closeRes = await fetch(`/api/recruit/close/${postId}`, { method: 'PATCH' });
              if (!closeRes.ok) throw new Error('모집 마감에 실패했습니다.');
              alert('모집이 마감되었습니다.');
              closeBtn.disabled = true;
              closeBtn.textContent = '모집 마감됨';
            } catch (err) {
              alert(err.message);
            }
          }
        };

        deleteBtn.onclick = async () => {
          if (confirm('정말 이 게시글을 삭제하시겠습니까?')) {
            try {
              const deleteRes = await fetch(`/api/recruit/${postId}`, { method: 'DELETE' });
              if (!deleteRes.ok) throw new Error('삭제에 실패했습니다.');
              alert('게시글이 삭제되었습니다.');
              window.location.href = 'post-list';
            } catch (err) {
              alert(err.message);
            }
          }
        };
      }

      document.getElementById('attendPostBtn').onclick = async () => {
        if (confirm('정말 이 게시글에 참석하시겠습니까?')) {
          try {
            const attendRes = await fetch(`/api/recruit/attend/${postId}`, { method: 'POST' });
            if (attendRes.ok) alert('참석이 완료되었습니다.');
            else throw new Error('참석에 실패했습니다.');
          } catch (err) {
            alert(err.message);
          }
        }
      };

    } catch (err) {
      alert(err.message);
    }
  }

  loadPostDetail();
</script>
</body>
</html>
