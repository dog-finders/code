<!DOCTYPE html>
<html lang="kr">
<head>
    <meta charset="utf-8" />
    <title>모집글 상세 - 도그 파인더스</title>
    <link href="css/styles.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body>
    <div class="container mt-4">
        <h3 id="postTitle">로딩 중...</h3>
        <p><strong>작성자:</strong> <span id="postWriter"></span></p>
        <p><strong>위치:</strong> <span id="postLocation"></span></p>
        <p><strong>작성일:</strong> <span id="postDate"></span></p>
        <hr />
        <p id="postContent"></p>

        <a href="post-list.html" class="btn btn-secondary mt-3 me-2">목록으로 돌아가기</a>
        <button id="attendBtn" class="btn btn-primary mt-3 me-2">참석하기</button>
        <button id="deleteBtn" class="btn btn-danger mt-3" style="display: none;">삭제하기</button>
    </div>

    <script>
        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        async function loadPostDetail() {
            const postId = getQueryParam('id');
            if (!postId) {
                alert('잘못된 접근입니다.');
                window.location.href = 'post-list.html';
                return;
            }

            try {
                const res = await fetch(`/api/groups/${postId}`);
                if (!res.ok) throw new Error('게시글을 찾을 수 없습니다.');
                const post = await res.json();

                document.getElementById('postTitle').textContent = post.title;
                document.getElementById('postWriter').textContent = post.writer || '알 수 없음';
                document.getElementById('postLocation').textContent = post.location || '-';
                document.getElementById('postDate').textContent = new Date(post.created_at).toLocaleString();
                document.getElementById('postContent').textContent = post.content;

                // 로그인한 사용자 확인
                const currentUser = localStorage.getItem('username');
                if (currentUser && currentUser === post.writer) {
                    document.getElementById('deleteBtn').style.display = 'inline-block';
                }

            } catch (err) {
                alert(err.message);
                window.location.href = 'post-list.html';
            }
        }

        async function attendPost() {
            const postId = getQueryParam('id');
            try {
                const res = await fetch(`/api/groups/${postId}/attend`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(errorData.message || '참석 신청에 실패했습니다.');
                }
                alert('참석 신청이 완료되었습니다!');
            } catch (err) {
                alert(err.message);
            }
        }

        async function deletePost() {
            const confirmed = confirm('정말 이 글을 삭제하시겠습니까?');
            if (!confirmed) return;

            const postId = getQueryParam('id');
            try {
                const res = await fetch(`/api/groups/${postId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                });
                if (!res.ok) throw new Error('삭제에 실패했습니다.');

                alert('게시글이 삭제되었습니다.');
                window.location.href = 'post-list.html';
            } catch (err) {
                alert(err.message);
            }
        }

        document.getElementById('attendBtn').addEventListener('click', attendPost);
        document.getElementById('deleteBtn').addEventListener('click', deletePost);

        loadPostDetail();
    </script>
</body>
</html>
//